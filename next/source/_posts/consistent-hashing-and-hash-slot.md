---
title: 一致性哈希和哈希槽
translate_title: consistent-hashing-and-hash-slot
categories:
  - 分布式设计
tags:
  - 一致性哈希
  - 哈希槽
  - redis
date: 2019-09-18 18:58:18
---

### 一致性哈希的引入
一个网站如果要提升其访问速度，通常会对静态资源进行缓存起来，当业务量比较小的时候，一台机器就可以完全cache 住所有的资源，当业务迅速发展，一台机器已经装不下所有的静态资源，就需要多台机器来共同缓存，这就带来了一些问题，多台机器如何分配资源以及资源的定位。最简单的做法是对资源进行分批，分别放到不同的机器上，然后建立一张表来维护资源的映射关系。当机器数量越来越多时，维护映射表也是一件繁琐的事情，而且容易出错。这个时候就需要一种算法可以自动地将资源映射到机器上，普通的哈希能解决资源映射这个问题，但是当机器数量变动时，机器缓存的资源会大概率重新哈希到另外机器，为了尽量减少资源的迁移，于是就有了一致性哈希算法。
<!-- more -->
### 基本概念
一致性hash是一个0-2^32的闭合圆，计算一致性哈希可以简单的分为三个步骤：
1. 对每个节点都进行hash（通常使用其节点的IP或是具有唯一标示的数据进行)，将其值分布在这个闭合圆上
1. 将某个资源进行hash，对应到哈希环上的某个位置
1. 从这个位置开始沿着顺时针方向找到的第一个节点作为存储的节点

### 虚拟节点
当节点数量比较少时，节点在哈希环的分布就会不均匀，这就会造成某些节点的压力比较大，而其他节点处于空闲的不合理情况，为了解决这个问题，在哈希环上会增加虚拟节点，使得所有的节点（真实节点和虚拟节点）能够均匀地分布在哈希环上，而这些虚拟节点会对应到真实的节点上

### 特点
1. 一致性哈希算法解决的问题是：在分布式系统下，当机器数量变动时，尽量减少受影响的缓存
1. 增加虚拟节点是为了避免哈希环的倾斜，均匀的把资源分配到各个机器上

### 哈希槽
redis 集群采用数据分片的哈希槽来进行数据的存储和读取。redis cluster 总有2^14=16384个槽，这些槽区会分配到所有的master 节点。每个key 通过crc16校验对16384取模计算出槽区，然后再找到对应的master节点。使用哈希槽的好处就是可以方便的增加或者减少节点。

### 重新分片
redis 集群的重新分片可以将任意槽从某个节点迁移到另外一个节点，重新分片可以在线进行。在数据迁移过程中，有部分数据在源节点，部分数据在目标节点中。当客户端向源节点发送一个与数据库键有关的命令时，并且这个键恰好处于正在迁移的槽中：
1. 源节点先在自己的数据库里查找该键，如果找到，则执行客户端发送的命令。
1. 如果找不到，源节点会向客户端发送一个ASK错误，并指引客户端转向目标节点，客户端再想目标节点发送想要执行的命令。

### 对比
1. 一致性哈希主要是解决分布式缓存失效的问题
1. 哈希槽主要应用在分布式持久性存储
1. 哈希槽实现简单，而一致性哈希更加灵活
1. 当节点失效时，哈希槽需要有一个从节点来顶替，否则集群会不可用，一致性哈希会自动重新分配到其他节点

### 参考
[白话解析：一致性哈希算法](https://www.zsythink.net/archives/1182)
